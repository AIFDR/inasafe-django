{% extends "realtime/base.html" %}
{% load staticfiles %}
{% load leaflet_tags %}
{% load bootstrap %}
{% load pipeline %}

{% block head_resources %}
    {{ block.super }}
    {% leaflet_js %}
    {% leaflet_css %}
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="{% static 'realtime/css/MarkerCluster.user-map.ie.css' %}" />
    <![endif]-->
    {% stylesheet 'realtime_contrib' %}
    {% stylesheet 'realtime_appcss' %}
    {% stylesheet 'main' %}
    {% javascript 'realtime_contrib' %}
    {% javascript 'realtime_templates' %}
    {% javascript 'realtime_appjs' %}
    {{ form.media }}
{% endblock head_resources %}

{% block nav_second %}
    <nav class="nav-second navbar-collapse collapse">
        <ul class="menu">
            <li class="menu-item active">
                <a href="#">Map</a>
            </li>
            <li class="menu-item">
                <a href="{% url 'realtime:api_root' %}">API Browser</a>
            </li>
        </ul>
    </nav>
{% endblock %}

{% block main_content %}
    <div class="row center-block">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Map</h3>
            </div>
            <div class="panel-body" style="height: 500px">
                <!-- Leaflet Map div -->
                {% leaflet_map "map" %}

                <!-- All the templates from view-->
            </div>
        </div>
    </div>
{% endblock main_content %}

{% block filter_content %}
    <div class="row center-block">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Filters</h3>
            </div>
            <div class="panel-body">
                <form id="event-filter">
                    <span class="row">
                        <span class="col-xs-6 col-sm-4">
                            {{ form.start_date|bootstrap_horizontal:'col-md-5' }}
                        </span>
                        <span class="col-xs-6 col-sm-4">
                            {{ form.end_date|bootstrap_horizontal:'col-md-5' }}
                        </span>
                        <span class="clearfix"></span>
                    </span>
                    <span class="row">
                        <span class="col-xs-6 col-sm-4">
                            {{ form.minimum_magnitude|bootstrap_horizontal:'col-md-5' }}
                        </span>
                        <span class="col-xs-6 col-sm-4">
                            {{ form.maximum_magnitude|bootstrap_horizontal:'col-md-5' }}
                        </span>
                        <span class="clearfix"></span>
                    </span>
                    <span class="row">
                        <input id="clear-filter" type="button" value="Clear Filter"
                               class="col-xs-6 col-sm-2 col-md-1 btn">
                        <input id="submit-filter" type="submit" value="Update"
                               class="col-xs-6 col-sm-2 col-md-1 btn btn-primary">
                    </span>
                </form>
            </div>
        </div>
    </div>
{% endblock filter_content %}

{% block table_content %}
    <div class="row center-block" id="realtime_table_div">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Table</h3>
            </div>
            <div class="panel-body">
                <table class="table table-striped table-bordered table-hover" id="realtime-table">
                    <thead>
                    <th>Time</th>
                    <th>Location Description</th>
                    <th>Magnitude</th>
                    <th>Depth</th>
                    <th>Shake Id</th>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock table_content %}

{% block js_container %}
    <script type="text/javascript">
        var base_map, dynaTable;

        //Initialize Basemap Layer
        base_map = createBasemap(
                '{{ leaflet_tiles.url }}',
                '{{ leaflet_tiles.attribution | safe }}');

        //Create Map with prepared base_map
        map = L.map('map', {
            layers: [base_map]
        });
        map.fitWorld().zoomIn();
        // make popup in center when opened
        map.on('popupopen', function (e) {
            var px = map.project(e.popup._latlng); // find the pixel location on the map where the popup anchor is
            px.y -= e.popup._container.clientHeight / 2; // find the height of the popup container, divide by 2, subtract from the Y axis of marker location
            map.panTo(map.unproject(px), {animate: true}); // pan to new center
        });

        //url to get json of events
        var get_events_url = '{% url "realtime:earthquake_feature_list" %}';

        var class_name = 'marker-cluster marker-cluster-project' + 1;
        markers = new L.markerClusterGroup({
            iconCreateFunction: (function (class_name) {
                return function (cluster) {
                    return L.divIcon({
                        html: '<div><span>' + cluster.getChildCount() + '</span></div>',
                        className: class_name,
                        iconSize: L.point(40, 40)
                    });
                }
            })(class_name)
        }).addTo(map);

        project_icon_path = "{% static 'realtime/img/earthquake.png' %}";
        project_shadow_icon_path = "{% static 'realtime/img/earthquake-shadow.png' %}";
        earthquakeIcon = createIconMarker(
                project_icon_path, project_shadow_icon_path);

        // create dynatable
        var jsonTableContents = [];
        var showEventHandler = createShowEventHandler(map, markers,
                map_events);
        {#    Use magic number 000 for placeholder#}
        var report_url = '{% url "realtime:earthquake_report_detail" shake_id='000' language=language %}'
        var showReportHandler = createShowReportHandler(report_url);
        var button_templates = [
            {
                name: 'Show',
                handler: 'showEventHandler'
            },
            {
                name: 'Report',
                handler: 'showReportHandler'
            }
        ];


        function getEarthquakeEventsJson(event_json) {
            markers.clearLayers();
            L.geoJson(event_json, {
                onEachFeature: onEachFeature,
                pointToLayer: function (feature, latlng) {
                    var marker = L.marker(latlng, {icon: earthquakeIcon});
                    map_events[feature.properties.shake_id] = marker;
                    return marker;
                }
            }).addTo(markers);
            jsonTableContents = [];
            for (var i = 0; i < event_json.features.length; ++i) {
                jsonTableContents[i] = event_json.features[i].properties;
            }
            dynaTable.settings.dataset.originalRecords = jsonTableContents;
            dynaTable.paginationPerPage.set(100);
            dynaTable.process();
        }

        function onEachFeature(feature, layer) {
            // add feature to map_events index
            // Set the popup content if it does have the content
            if (feature.properties) {
                var properties = feature.properties;
                var popup_content = window.JST.popup_content(properties);
                layer.bindPopup(popup_content);
            }
        }

        // add LocationFilter control
        var locationFilter = L.locationFilter({
            enableButton: {
                enableText: "{{ select_area_text }}",
                disableText: "{{ remove_area_text }}"
            },
            adjustButton: {
                text: "{{ select_current_zoom_text }}"
            },
            buttonPosition: 'topleft'
        }).addTo(map);

        $(document).ready(function () {

            var $root = $('html, body');
            var $navbar = $('#navbar');

            $('a').click(function () {
                $root.animate({
                    scrollTop: $($.attr(this, 'href')).offset().top - $navbar
                            .height()
                }, 500);
                return false;
            });

            dynaTable = $('#realtime-table').dynatable({
                table: {
                    defaultColumnIdStyle: 'underscore',
                },
                writers: {
                    _rowWriter: createActionRowWriter(button_templates)
                },
                dataset: {
                    records: jsonTableContents
                }
            }).data('dynatable');

            // add action column to dynatable
            addActionColumn('#realtime-table', 'Action');

            // move table control div
            var $table = $("#realtime-table");
            var $table_sibling = $table.prev();
            var $table_responsive = $("<div></div>").addClass("table-responsive");
            $table_responsive.append($table.detach());
            $table_responsive.insertAfter($table_sibling);


            $.get(get_events_url, function (data) {
                event_json = data;
                getEarthquakeEventsJson(data);
                map.fitBounds(markers.getBounds(), {padding: [100, 100]});
            });

            // add content filter handler
            // update via ajax request
            {% if server_side_filter %}
            var updateFilterHandler = createUpdateFilterHandler(get_events_url,
                    $("#event-filter"),
                    locationFilter,
                    getEarthquakeEventsJson);
            {% else %}
            // update via client filters
            var updateFilterHandler = createClientUpdateFilterHandler(get_events_url,
                    $("#event-filter"),
                    locationFilter,
                    getEarthquakeEventsJson);
            {% endif %}

            locationFilter.on("change", updateFilterHandler);
            locationFilter.on("enabled", updateFilterHandler);
            locationFilter.on("disabled", updateFilterHandler);

            $("#submit-filter").click(updateFilterHandler);
            $("#clear-filter").click(function (e) {
                $("#event-filter input.form-control").val('');
            });

            {% if iframe %}
{#                If in iframe, remove unnecessary informations#}
                $map = $("#map").detach();
                $body = $("body");
                $main_container = $("body>.container").hide();
                $map.appendTo($body);

            {% endif %}
        });
    </script>
{% endblock js_container %}
