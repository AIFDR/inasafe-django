#
# Production server with UWSGI configured to run on port 1818
#
# Usage:
# fig -f fig-.yml <command>
#
# Typical useage:
#
# fig build
# fig up -d uwsgi
# fig run migrate
# fig run collectstatic


# To get an interactive shell in the django context:
#
# fig run shell

db:
  image: kartoza/postgis
  volumes:
    - ./postgres_data:/var/lib/postgresql
  environment:
    - USERNAME=docker
    - PASS=docker

uwsgi:
  build: docker-prod
  hostname: uwsgi
  environment:
    - DATABASE_NAME=gis
    - DATABASE_USERNAME=docker
    - DATABASE_PASSWORD=docker
    - DATABASE_HOST=db
    - DJANGO_SETTINGS_MODULE=core.settings.prod_docker
  volumes:
    - ./django_project:/home/web/django_project
  ports:
    - "1818:49360"
  links:
    - db:db

migrate:
  build: docker-prod
  hostname: migrate
  entrypoint: /usr/bin/python
  command: "manage.py migrate"
  environment:
    - DATABASE_NAME=gis
    - DATABASE_USERNAME=docker
    - DATABASE_PASSWORD=docker
    - DATABASE_HOST=db
    - DJANGO_SETTINGS_MODULE=core.settings.prod_docker
  volumes:
    - ./django_project:/home/web/django_project
  links:
    - db:db

collectstatic:
  build: docker-prod
  hostname: collectstatic
  entrypoint: /usr/bin/python
  command: "manage.py collectstatic --noinput"
  environment:
    - DATABASE_NAME=gis
    - DATABASE_USERNAME=docker
    - DATABASE_PASSWORD=docker
    - DATABASE_HOST=db
    - DJANGO_SETTINGS_MODULE=core.settings.prod_docker
  volumes:
    - ./django_project:/home/web/django_project
  links:
    - db:db

shell:
  # Note you have to press enter after starting the shell to get to your prompt
  build: docker-prod
  hostname: shell
  entrypoint: /bin/bash
  command: -i
  environment:
    - DATABASE_NAME=gis
    - DATABASE_USERNAME=docker
    - DATABASE_PASSWORD=docker
    - DATABASE_HOST=db
    - DJANGO_SETTINGS_MODULE=core.settings.prod_docker
  volumes:
    - ./django_project:/home/web/django_project
  links:
    - db:db
